name: Flutter Standard CI

on:
  push:
    branches:
      - main
      - master
      - dev
  pull_request:
    branches:
      - main
      - master
      - dev

jobs:
  # Job 1: Kiá»ƒm tra Code Quality & Testing
  code_quality_and_test:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: âš™ï¸ Setup Environment 
        run: |
          if [ -f ".env.example" ]; then
            cp .env.example .env
            echo "Created .env from .env.example"
          else
            touch .env
            echo "Created empty .env"
          fi

      - name: ğŸ—ï¸ Run build_runner (Optional)
        # Bá» comment náº¿u báº¡n khÃ´ng commit cÃ¡c file .g.dart lÃªn Git
        # run: dart run build_runner build --delete-conflicting-outputs
        run: echo "Skipped build_runner. Uncomment if needed."

      - name: âœ¨ Check formatting
        # Sáº½ bÃ¡o lá»—i há»ng CI náº¿u code chÆ°a Ä‘Æ°á»£c format báº±ng `dart format .`
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Analyze project
        run: flutter analyze

      - name: ğŸ§ª Run tests
        # Chá»‰ cháº¡y náº¿u thÆ° má»¥c test tá»“n táº¡i Ä‘á»ƒ trÃ¡nh lá»—i
        run: |
          if [ -d "test" ]; then
            flutter test
          else
            echo "No 'test' directory found. Skipping tests."
          fi

  # Job 2: Build thá»­ má»™t báº£n Debug APK Ä‘á»ƒ Ä‘áº£m báº£o code cÃ³ thá»ƒ biÃªn dá»‹ch thÃ nh cÃ´ng
  # KhÃ¡c vá»›i Release, Debug APK build nhanh hÆ¡n vÃ  khÃ´ng yÃªu cáº§u Keystore
  verify_build_android:
    name: Verify Build Android
    runs-on: ubuntu-latest
    needs: code_quality_and_test # Build sau khi Job 1 Ä‘Ã£ thÃ nh cÃ´ng xanh
    timeout-minutes: 30

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: âš™ï¸ Setup Environment 
        run: |
          if [ -f ".env.example" ]; then
            cp .env.example .env
          else
            touch .env
          fi

      - name: ğŸ› ï¸ Build Debug APK
        run: flutter build apk --debug
